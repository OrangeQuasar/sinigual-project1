{% extends "base.html" %}

{% block content %}
<div class="pdf-view-container">
    <div class="pdf-viewer-main">
        <h2>{{ pdf.title }}</h2>
        <p>投稿者: {{ pdf.username }}</p>
        <div class="pdf-viewer-controls">
            <button id="prev-page">＜ 前へ</button>
            <span id="page-info"></span>
            <button id="next-page">次へ ＞</button>
        </div>
        <canvas id="pdf-canvas"></canvas>
    </div>
    <div class="pdf-sidebar">
        <h3>リアクション</h3>
        <div class="reactions-container">
            <div class="reactions">
                {% for reaction in pdf.reactions %}
                <span class="reaction-emoji {% if reaction.emoji in pdf.user_reactions %}user-reacted{% endif %}"
                      data-pdf-id="{{ pdf.id }}" data-emoji="{{ reaction.emoji }}">
                    {{ reaction.emoji }} <span class="reaction-count">{{ reaction.count }}</span>
                </span>
                {% endfor %}
            </div>
            <div class="add-reaction">
                <button class="add-reaction-btn">+</button>
                <div class="emoji-picker">
                    <span data-pdf-id="{{ pdf.id }}" data-emoji="👍">👍</span>
                    <span data-pdf-id="{{ pdf.id }}" data-emoji="❤️">❤️</span>
                    <span data-pdf-id="{{ pdf.id }}" data-emoji="😂">😂</span>
                    <span data-pdf-id="{{ pdf.id }}" data-emoji="🎉">🎉</span>
                </div>
            </div>
        </div>
        <hr>
        <h3>共有</h3>
        <button id="share-btn">このページのURLをコピー</button>
        <hr>
        <h3>コメント</h3>
        <div class="comment-section">
            <form action="{{ url_for('add_comment', pdf_id=pdf.id) }}" method="post">
                <textarea name="content" placeholder="コメントを追加..." required></textarea>
                <button type="submit">投稿</button>
            </form>
            <div class="comment-list">
                {% for comment in comments recursive %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <p><strong>{{ comment.username }}</strong> <small>{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
                    <p>{{ comment.content | nl2br }}</p>
                    <a href="#" class="reply-btn" data-comment-id="{{ comment.id }}">返信する</a>
                    {% if comment.replies %}
                        <div class="replies">
                            {{ loop(comment.replies) }}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="reply-form-template" style="display: none;">
    <form action="{{ url_for('add_comment', pdf_id=pdf.id) }}" method="post" class="reply-form">
        <input type="hidden" name="parent_id" value="">
        <textarea name="content" placeholder="返信を追加..." required></textarea>
        <button type="submit">返信</button>
        <button type="button" class="cancel-reply-btn">キャンセル</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    // ( ... PDF.js の読み込み、リアクション、共有、コメント返信のJavaScriptコードは前の回答と同じです ... )
</script>
{% endblock %}