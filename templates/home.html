{% extends "base.html" %}

{% block content %}
<section class="pdf-gallery">
    <h2>„Åø„Çì„Å™„ÅÆ„ÉÅ„É©„Ç∑</h2>
    <div class="pdf-grid">
        {% for pdf in pdfs %}
        <div class="pdf-card" id="pdf-card-{{ pdf.id }}">
            <a href="#" class="pdf-thumbnail" data-filename="{{ pdf.filename }}">
                {% if pdf.thumbnail_filename %}
                    <img src="{{ url_for('static', filename='thumbnails/' + pdf.thumbnail_filename) }}" alt="{{ pdf.title }}„ÅÆ„Çµ„É†„Éç„Ç§„É´">
                {% else %}
                    <img src="https://placehold.jp/150x212.png?text=No+Image" alt="No Image">
                {% endif %}
                <h3>{{ pdf.title }}</h3>
                <p>ÊäïÁ®øËÄÖ: {{ pdf.username }}</p>
            </a>
            <div class="reactions-container">
                <div class="reactions">
                    {% for reaction in pdf.reactions %}
                    <span class="reaction-emoji {% if reaction.emoji in pdf.user_reactions %}user-reacted{% endif %}"
                          data-pdf-id="{{ pdf.id }}" data-emoji="{{ reaction.emoji }}">
                        {{ reaction.emoji }} <span class="reaction-count">{{ reaction.count }}</span>
                    </span>
                    {% endfor %}
                </div>
                <div class="add-reaction">
                    <button class="add-reaction-btn" data-pdf-id="{{ pdf.id }}">+</button>
                    <div class="emoji-picker">
                        <span data-pdf-id="{{ pdf.id }}" data-emoji="üëç">üëç</span>
                        <span data-pdf-id="{{ pdf.id }}" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
                        <span data-pdf-id="{{ pdf.id }}" data-emoji="üòÇ">üòÇ</span>
                        <span data-pdf-id="{{ pdf.id }}" data-emoji="üéâ">üéâ</span>
                        <span data-pdf-id="{{ pdf.id }}" data-emoji="ü§î">ü§î</span>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <p>„Åæ„Å†„ÉÅ„É©„Ç∑„ÅåÊäïÁ®ø„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
        {% endfor %}
    </div>
</section>

<!-- PDFË°®Á§∫Áî®„ÅÆ„É¢„Éº„ÉÄ„É´ -->
<div id="pdf-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="pdf-viewer-controls">
            <button id="prev-page">Ôºú Ââç„Å∏</button>
            <span id="page-info"></span>
            <button id="next-page">Ê¨°„Å∏ Ôºû</button>
        </div>
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    // importÊñá„Çí‰Ωø„Å£„Å¶„ÄÅpdf.mjs„É¢„Ç∏„É•„Éº„É´„Åã„ÇâpdfjsLib„ÇíÁõ¥Êé•„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô
    import * as pdfjsLib from "{{ url_for('static', filename='pdfjs/build/pdf.mjs') }}";

    // --- PDF„Éì„É•„Éº„ÉØ„ÉºÂá¶ÁêÜ ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='pdfjs/build/pdf.worker.mjs') }}";

    const modal = document.getElementById('pdf-modal');
    const canvas = document.getElementById('pdf-canvas');
    const closeButton = document.querySelector('.close-button');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');

    let currentPdf = null;
    let currentPageNum = 1;
    let totalPages = 0;

    function loadAndRenderPdf(url) {
        const cMapUrl = "{{ url_for('static', filename='pdfjs/web/cmaps/') }}/";
        const loadingTask = pdfjsLib.getDocument({ url, cMapUrl, cMapPacked: true });

        loadingTask.promise.then(pdf => {
            currentPdf = pdf;
            totalPages = pdf.numPages;
            currentPageNum = 1;
            renderPage(currentPageNum);
        });
    }

    function renderPage(pageNum) {
        currentPdf.getPage(pageNum).then(page => {
            const viewport = page.getViewport({ scale: 1.5 });
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            page.render({ canvasContext: context, viewport: viewport });
            
            pageInfo.textContent = `„Éö„Éº„Ç∏ ${pageNum} / ${totalPages}`;
            prevButton.disabled = (pageNum <= 1);
            nextButton.disabled = (pageNum >= totalPages);
        });
    }

    document.querySelectorAll('.pdf-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', event => {
            event.preventDefault();
            const filename = thumbnail.dataset.filename;
            const pdfUrl = `{{ url_for('uploaded_file', filename='') }}${filename}`;
            modal.style.display = 'flex';
            loadAndRenderPdf(pdfUrl);
        });
    });

    closeButton.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', event => {
        if (event.target == modal) modal.style.display = 'none';
    });

    prevButton.addEventListener('click', () => {
        if (currentPageNum > 1) renderPage(--currentPageNum);
    });

    nextButton.addEventListener('click', () => {
        if (currentPageNum < totalPages) renderPage(++currentPageNum);
    });

    // --- „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ ---
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-reaction-btn')) {
            const picker = e.target.nextElementSibling;
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        } else if (e.target.dataset.emoji && e.target.dataset.pdfId) {
            const pdfId = e.target.dataset.pdfId;
            const emoji = e.target.dataset.emoji;
            
            const picker = e.target.closest('.emoji-picker');
            if (picker) picker.style.display = 'none';

            sendReaction(pdfId, emoji);
        }
    });

    async function sendReaction(pdfId, emoji) {
        const response = await fetch(`/react/${pdfId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emoji: emoji }),
        });

        if (response.ok) {
            const result = await response.json();
            updateReactionUI(pdfId, result.emoji, result.count, result.action);
        } else {
            const error = await response.json();
            alert(error.error || '„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
    }

    function updateReactionUI(pdfId, emoji, count, action) {
        const card = document.getElementById(`pdf-card-${pdfId}`);
        const reactionsContainer = card.querySelector('.reactions');
        let reactionSpan = reactionsContainer.querySelector(`[data-emoji="${emoji}"]`);

        if (count > 0) {
            if (!reactionSpan) {
                reactionSpan = document.createElement('span');
                reactionSpan.className = 'reaction-emoji';
                reactionSpan.dataset.pdfId = pdfId;
                reactionSpan.dataset.emoji = emoji;
                reactionsContainer.appendChild(reactionSpan);
            }
            reactionSpan.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
            
            if (action === 'added') {
                reactionSpan.classList.add('user-reacted');
            } else {
                reactionSpan.classList.remove('user-reacted');
            }
        } else {
            if (reactionSpan) reactionSpan.remove();
        }
    }
</script>
{% endblock %}